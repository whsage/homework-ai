# çœŸå®é€šçŸ¥ç³»ç»Ÿ - å®æ–½æŒ‡å—

## ğŸ“‹ å·²å®Œæˆçš„å·¥ä½œ

### âœ… 1. è®¾è®¡æ–‡æ¡£
- åˆ›å»ºäº†å®Œæ•´çš„ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼š`NOTIFICATION_SYSTEM_DESIGN.md`
- å®šä¹‰äº† 5 ç§é€šçŸ¥ç±»å‹ï¼šæˆå°±ã€è¿ç»­å­¦ä¹ ã€å­¦ç§‘ä¸“ç²¾ã€æ¯æ—¥é¼“åŠ±ã€ç³»ç»Ÿé€šçŸ¥

### âœ… 2. æ•°æ®åº“è„šæœ¬
- åˆ›å»ºäº†è¿ç§»è„šæœ¬ï¼š`supabase/migrations/create_notification_system.sql`
- åŒ…å«è¡¨ç»“æ„ã€ç´¢å¼•ã€RLS ç­–ç•¥å’Œè‡ªåŠ¨è§¦å‘å™¨

### âœ… 3. å‰ç«¯ç»„ä»¶
- æ”¹é€ äº† `NotificationDropdown.jsx`ï¼Œæ”¯æŒï¼š
  - ä»æ•°æ®åº“è¯»å–çœŸå®é€šçŸ¥
  - å®æ—¶ç›‘å¬æ–°é€šçŸ¥
  - æ ‡è®°å·²è¯»/æœªè¯»
  - åŠ è½½çŠ¶æ€å’Œç©ºçŠ¶æ€
  - æ—¶é—´æ ¼å¼åŒ–

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

1. æ‰“å¼€ Supabase Dashboard
   ```
   https://supabase.com/dashboard
   ```

2. é€‰æ‹©ä½ çš„é¡¹ç›®

3. è¿›å…¥ **SQL Editor**

4. å¤åˆ¶ `supabase/migrations/create_notification_system.sql` çš„å†…å®¹

5. ç²˜è´´å¹¶ç‚¹å‡» **Run** æ‰§è¡Œ

6. ç¡®è®¤æ‰§è¡ŒæˆåŠŸï¼ˆåº”è¯¥çœ‹åˆ° "Success. No rows returned"ï¼‰

---

### ç¬¬äºŒæ­¥ï¼šæµ‹è¯•é€šçŸ¥ç³»ç»Ÿ

#### æµ‹è¯•æˆå°±é€šçŸ¥

1. ç™»å½•åº”ç”¨

2. å®Œæˆç¬¬ 1 ä¸ªä½œä¸š
   - åº”è¯¥æ”¶åˆ°ï¼šğŸ‰ å¼€å¯å­¦ä¹ ä¹‹æ—…ï¼

3. å®Œæˆç¬¬ 5 ä¸ªä½œä¸š
   - åº”è¯¥æ”¶åˆ°ï¼šğŸŒŸ åˆéœ²é”‹èŠ’ï¼

4. å®Œæˆç¬¬ 10 ä¸ªä½œä¸š
   - åº”è¯¥æ”¶åˆ°ï¼šğŸ† å­¦ä¹ å°èƒ½æ‰‹ï¼
   - åŒæ—¶æ”¶åˆ°ï¼šâ¬†ï¸ æ­å–œå‡çº§åˆ° Lv.2ï¼

#### æµ‹è¯•é€šçŸ¥æ˜¾ç¤º

1. ç‚¹å‡»å³ä¸Šè§’çš„é“ƒé“›å›¾æ ‡

2. åº”è¯¥çœ‹åˆ°åˆšæ‰æ”¶åˆ°çš„é€šçŸ¥

3. ç‚¹å‡»é€šçŸ¥å¯ä»¥è·³è½¬åˆ°ç›¸åº”é¡µé¢

4. ç‚¹å‡»"å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»"å¯ä»¥æ¸…é™¤æœªè¯»æ ‡è®°

---

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯å®æ—¶é€šçŸ¥

1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£

2. åœ¨çª—å£ A å®Œæˆä¸€ä¸ªä½œä¸š

3. åœ¨çª—å£ B åº”è¯¥ç«‹å³çœ‹åˆ°æ–°é€šçŸ¥ï¼ˆæ— éœ€åˆ·æ–°ï¼‰

---

## ğŸ¯ é€šçŸ¥è§¦å‘æ—¶æœº

### è‡ªåŠ¨è§¦å‘ï¼ˆæ•°æ®åº“è§¦å‘å™¨ï¼‰

âœ… **æˆå°±é‡Œç¨‹ç¢‘**
- å®Œæˆ 1, 5, 10, 20, 50, 100 ä¸ªä½œä¸šæ—¶è‡ªåŠ¨è§¦å‘

âœ… **ç­‰çº§æå‡**
- Lv.1 â†’ Lv.2ï¼ˆ10 ä¸ªä½œä¸šï¼‰
- Lv.2 â†’ Lv.3ï¼ˆ20 ä¸ªä½œä¸šï¼‰
- Lv.3 â†’ Lv.4ï¼ˆ50 ä¸ªä½œä¸šï¼‰
- Lv.4 â†’ Lv.5ï¼ˆ100 ä¸ªä½œä¸šï¼‰

### æœªæ¥å¯æ·»åŠ ï¼ˆéœ€è¦åº”ç”¨å±‚é€»è¾‘ï¼‰

â³ **è¿ç»­å­¦ä¹ **
- è¿ç»­ 3, 7, 14, 30 å¤©å­¦ä¹ 

â³ **å­¦ç§‘ä¸“ç²¾**
- æŸå­¦ç§‘å®Œæˆ 5, 10, 20 ä¸ªä½œä¸š

â³ **æ¯æ—¥é¼“åŠ±**
- æ¯å¤©é¦–æ¬¡ç™»å½•

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### user_notifications è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| user_id | UUID | ç”¨æˆ· ID |
| type | VARCHAR | é€šçŸ¥ç±»å‹ |
| title | TEXT | é€šçŸ¥æ ‡é¢˜ |
| message | TEXT | é€šçŸ¥å†…å®¹ |
| icon | VARCHAR | å›¾æ ‡åç§° |
| color | VARCHAR | é¢œè‰²ç±» |
| link | VARCHAR | è·³è½¬é“¾æ¥ |
| read | BOOLEAN | æ˜¯å¦å·²è¯» |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| metadata | JSONB | é¢å¤–æ•°æ® |

---

## ğŸ” è°ƒè¯•å’ŒéªŒè¯

### æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥

```sql
SELECT * FROM user_notifications
ORDER BY created_at DESC;
```

### æŸ¥çœ‹æŸä¸ªç”¨æˆ·çš„é€šçŸ¥

```sql
SELECT * FROM user_notifications
WHERE user_id = 'YOUR_USER_ID'
ORDER BY created_at DESC;
```

### æ‰‹åŠ¨åˆ›å»ºæµ‹è¯•é€šçŸ¥

```sql
INSERT INTO user_notifications (user_id, type, title, message, icon, color, link)
VALUES (
    'YOUR_USER_ID',
    'system',
    'ğŸ‰ æµ‹è¯•é€šçŸ¥',
    'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚',
    'Bell',
    'text-blue-500 bg-blue-50',
    '/'
);
```

### æ¸…ç©ºæ‰€æœ‰é€šçŸ¥ï¼ˆæµ‹è¯•ç”¨ï¼‰

```sql
DELETE FROM user_notifications;
```

---

## ğŸ¨ è‡ªå®šä¹‰é€šçŸ¥

### æ·»åŠ æ–°çš„é€šçŸ¥ç±»å‹

1. åœ¨ `create_notification_system.sql` ä¸­æ·»åŠ æ–°çš„è§¦å‘é€»è¾‘

2. åœ¨ `NotificationDropdown.jsx` çš„ `ICON_MAP` ä¸­æ·»åŠ æ–°å›¾æ ‡

3. æ ¹æ®éœ€è¦è°ƒæ•´é¢œè‰²å’Œæ ·å¼

### ä¿®æ”¹é€šçŸ¥å†…å®¹

ç¼–è¾‘ `check_achievement_notifications()` å‡½æ•°ä¸­çš„ CASE è¯­å¥ï¼š

```sql
CASE 
    WHEN total_count = 1 THEN 'ä½ çš„è‡ªå®šä¹‰æ ‡é¢˜'
    WHEN total_count = 5 THEN 'å¦ä¸€ä¸ªè‡ªå®šä¹‰æ ‡é¢˜'
    ...
END
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å·²å®æ–½

âœ… åˆ›å»ºäº†ç´¢å¼•ï¼ˆuser_id, created_at, readï¼‰
âœ… é™åˆ¶æŸ¥è¯¢æ•°é‡ï¼ˆæœ€å¤š 10 æ¡ï¼‰
âœ… ä½¿ç”¨ RLS ç­–ç•¥ä¿æŠ¤æ•°æ®

### æœªæ¥ä¼˜åŒ–

â³ å®šæœŸæ¸…ç†è¿‡æœŸé€šçŸ¥ï¼ˆ30 å¤©å‰çš„å·²è¯»é€šçŸ¥ï¼‰
â³ æ·»åŠ é€šçŸ¥å»é‡é€»è¾‘
â³ å®ç°é€šçŸ¥åˆ†é¡µåŠ è½½

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: é€šçŸ¥æ²¡æœ‰æ˜¾ç¤ºï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ•°æ®åº“è¿ç§»æ˜¯å¦æˆåŠŸæ‰§è¡Œ
2. RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®
3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. ç”¨æˆ·æ˜¯å¦å·²ç™»å½•

### Q: é€šçŸ¥ä¸æ˜¯å®æ—¶çš„ï¼Ÿ

**A:** ç¡®ä¿ï¼š
1. Supabase Realtime åŠŸèƒ½å·²å¯ç”¨
2. æµè§ˆå™¨æ”¯æŒ WebSocket
3. ç½‘ç»œè¿æ¥æ­£å¸¸

### Q: å¦‚ä½•é‡ç½®é€šçŸ¥ç³»ç»Ÿï¼Ÿ

**A:** æ‰§è¡Œä»¥ä¸‹ SQLï¼š
```sql
-- åˆ é™¤æ‰€æœ‰é€šçŸ¥
DELETE FROM user_notifications;

-- åˆ é™¤è§¦å‘å™¨
DROP TRIGGER IF EXISTS trigger_achievement_notifications ON user_stats;

-- åˆ é™¤å‡½æ•°
DROP FUNCTION IF EXISTS check_achievement_notifications();

-- åˆ é™¤è¡¨
DROP TABLE IF EXISTS user_notifications;

-- ç„¶åé‡æ–°æ‰§è¡Œè¿ç§»è„šæœ¬
```

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

1. **å³æ—¶åé¦ˆ**
   - å®Œæˆä½œä¸šåç«‹å³æ”¶åˆ°æˆå°±é€šçŸ¥
   - çº¢ç‚¹æç¤ºæœªè¯»é€šçŸ¥

2. **è¿›åº¦å¯è§†åŒ–**
   - é€šè¿‡é€šçŸ¥äº†è§£å­¦ä¹ è¿›åº¦
   - æ¸…æ¥šçŸ¥é“ä¸‹ä¸€ä¸ªç›®æ ‡

3. **æ¿€åŠ±æœºåˆ¶**
   - é‡Œç¨‹ç¢‘é€šçŸ¥æ¿€åŠ±æŒç»­å­¦ä¹ 
   - ç­‰çº§æå‡å¸¦æ¥æˆå°±æ„Ÿ

4. **ä¸ªæ€§åŒ–ä½“éªŒ**
   - æ ¹æ®ç”¨æˆ·è¡Œä¸ºæ¨é€ç›¸å…³é€šçŸ¥
   - ä¸åŒç±»å‹çš„é€šçŸ¥æœ‰ä¸åŒçš„æ ·å¼

---

## ğŸ“ åç»­è®¡åˆ’

### ç¬¬äºŒé˜¶æ®µï¼šè¿ç»­å­¦ä¹ é€šçŸ¥

åœ¨ `UploadZone.jsx` ä¸­æ·»åŠ ï¼š

```javascript
// æ£€æŸ¥è¿ç»­å­¦ä¹ å¤©æ•°
const checkStreakNotification = async (userId) => {
    const { data: sessions } = await supabase
        .from('sessions')
        .select('created_at')
        .eq('user_id', userId);
    
    const dates = sessions.map(s => new Date(s.created_at).toDateString());
    const uniqueDates = [...new Set(dates)];
    const streak = uniqueDates.length;
    
    if ([3, 7, 14, 30].includes(streak)) {
        await supabase.from('user_notifications').insert({
            user_id: userId,
            type: 'streak',
            title: 'ğŸ”¥ è¿ç»­å­¦ä¹ è¾¾æˆï¼',
            message: `æ­å–œï¼ä½ å·²ç»è¿ç»­å­¦ä¹  ${streak} å¤©äº†ã€‚ä¿æŒè¿™ä¸ªåŠ¿å¤´ï¼`,
            icon: 'Flame',
            color: 'text-orange-500 bg-orange-50',
            link: '/statistics',
            metadata: { streak }
        });
    }
};
```

### ç¬¬ä¸‰é˜¶æ®µï¼šå­¦ç§‘ä¸“ç²¾é€šçŸ¥

ç±»ä¼¼çš„é€»è¾‘ï¼Œæ£€æµ‹æŸä¸ªå­¦ç§‘çš„ä½œä¸šæ•°é‡ã€‚

### ç¬¬å››é˜¶æ®µï¼šæ¯æ—¥é¼“åŠ±é€šçŸ¥

åœ¨ç”¨æˆ·ç™»å½•æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€é¼“åŠ±é€šçŸ¥ã€‚

---

## âœ… æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤ï¼š

- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬å·²æ‰§è¡Œ
- [ ] NotificationDropdown ç»„ä»¶å·²æ›´æ–°
- [ ] ä»£ç å·²æäº¤åˆ° Git
- [ ] å·²åœ¨æœ¬åœ°æµ‹è¯•é€šçŸ¥åŠŸèƒ½
- [ ] å·²éªŒè¯å®æ—¶é€šçŸ¥å·¥ä½œæ­£å¸¸
- [ ] å·²æµ‹è¯•æ ‡è®°å·²è¯»åŠŸèƒ½
- [ ] å·²æ£€æŸ¥ç§»åŠ¨ç«¯æ˜¾ç¤ºæ•ˆæœ

---

**åˆ›å»ºæ—¶é—´ï¼š** 2026-01-24  
**çŠ¶æ€ï¼š** å¾…éƒ¨ç½²  
**é¢„è®¡å®Œæˆæ—¶é—´ï¼š** 10-15 åˆ†é’Ÿ
