# Supabase å­˜å‚¨æ¡¶è®¾ç½®æŒ‡å—

## ğŸ“¦ åˆ›å»ºç”¨æˆ·ä¸Šä¼ å­˜å‚¨æ¡¶

å¤´åƒä¸Šä¼ åŠŸèƒ½éœ€è¦åœ¨ Supabase ä¸­åˆ›å»ºä¸€ä¸ªå­˜å‚¨æ¡¶ï¼ˆStorage Bucketï¼‰ã€‚

### ğŸš€ æ­¥éª¤

#### 1. æ‰“å¼€ Supabase Storage

1. ç™»å½• Supabase Dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. åœ¨å·¦ä¾§å¯¼èˆªæ ç‚¹å‡» **Storage** å›¾æ ‡ï¼ˆğŸ“¦ï¼‰

#### 2. åˆ›å»ºæ–°å­˜å‚¨æ¡¶

1. ç‚¹å‡» **New Bucket** æŒ‰é’®
2. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **Name**: `user-uploads`
   - **Public bucket**: âœ… **å‹¾é€‰**ï¼ˆå…è®¸å…¬å¼€è®¿é—®ä¸Šä¼ çš„å›¾ç‰‡ï¼‰
   - **File size limit**: `2MB`ï¼ˆå¯é€‰ï¼Œé™åˆ¶å•ä¸ªæ–‡ä»¶å¤§å°ï¼‰
   - **Allowed MIME types**: `image/*`ï¼ˆå¯é€‰ï¼Œåªå…è®¸å›¾ç‰‡ï¼‰

3. ç‚¹å‡» **Create bucket**

#### 3. é…ç½®å­˜å‚¨æ¡¶ç­–ç•¥

åˆ›å»ºå­˜å‚¨æ¡¶åï¼Œéœ€è¦é…ç½® RLS ç­–ç•¥ä»¥å…è®¸ç”¨æˆ·ä¸Šä¼ å’Œè®¿é—®æ–‡ä»¶ã€‚

åœ¨ Supabase SQL Editor ä¸­è¿è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- å…è®¸å·²è®¤è¯ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶åˆ°è‡ªå·±çš„æ–‡ä»¶å¤¹
CREATE POLICY "Users can upload their own avatars"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
    bucket_id = 'user-uploads' 
    AND (storage.foldername(name))[1] = 'avatars'
    AND auth.uid()::text = (storage.foldername(name))[2]
);

-- å…è®¸æ‰€æœ‰äººæŸ¥çœ‹å…¬å¼€çš„å¤´åƒ
CREATE POLICY "Anyone can view avatars"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'user-uploads' AND (storage.foldername(name))[1] = 'avatars');

-- å…è®¸ç”¨æˆ·åˆ é™¤è‡ªå·±çš„å¤´åƒ
CREATE POLICY "Users can delete their own avatars"
ON storage.objects
FOR DELETE
TO authenticated
USING (
    bucket_id = 'user-uploads' 
    AND (storage.foldername(name))[1] = 'avatars'
    AND auth.uid()::text = (storage.foldername(name))[2]
);
```

### âœ… éªŒè¯è®¾ç½®

1. åœ¨ Storage é¡µé¢ï¼Œä½ åº”è¯¥çœ‹åˆ° `user-uploads` å­˜å‚¨æ¡¶
2. å­˜å‚¨æ¡¶åº”è¯¥æ ‡è®°ä¸º **Public**
3. åœ¨ Policies æ ‡ç­¾é¡µï¼Œä½ åº”è¯¥çœ‹åˆ° 3 ä¸ªç­–ç•¥

### ğŸ§ª æµ‹è¯•ä¸Šä¼ 

1. ç™»å½•åº”ç”¨
2. è®¿é—®ä¸ªäººè®¾ç½®é¡µé¢
3. ç‚¹å‡»å¤´åƒä¸Šä¼ å›¾ç‰‡
4. ä¸Šä¼ æˆåŠŸåï¼Œå¤´åƒåº”è¯¥ç«‹å³æ˜¾ç¤º
5. åˆ·æ–°é¡µé¢ï¼Œå¤´åƒåº”è¯¥ä¿æŒä¸å˜

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ï¼šä¸Šä¼ å¤±è´¥ï¼Œæç¤º "Bucket not found"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤å­˜å‚¨æ¡¶åç§°ä¸º `user-uploads`ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
- ç¡®è®¤å­˜å‚¨æ¡¶å·²åˆ›å»ºå¹¶ä¸”æ˜¯å…¬å¼€çš„

### é—®é¢˜ï¼šä¸Šä¼ æˆåŠŸä½†æ— æ³•æ˜¾ç¤ºå›¾ç‰‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦è®¾ç½®ä¸º Public
- æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®
- åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹å›¾ç‰‡ URL æ˜¯å¦å¯è®¿é—®

### é—®é¢˜ï¼š403 Forbidden é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç”¨æˆ·å·²ç™»å½•
- ç¡®è®¤æ–‡ä»¶è·¯å¾„æ ¼å¼æ­£ç¡®ï¼š`avatars/{user_id}-{timestamp}.{ext}`

---

## ğŸ“ æ–‡ä»¶è·¯å¾„ç»“æ„

ä¸Šä¼ çš„å¤´åƒæ–‡ä»¶å°†æŒ‰ä»¥ä¸‹ç»“æ„å­˜å‚¨ï¼š

```
user-uploads/
â””â”€â”€ avatars/
    â”œâ”€â”€ {user_id_1}-1234567890.jpg
    â”œâ”€â”€ {user_id_1}-1234567891.png
    â”œâ”€â”€ {user_id_2}-1234567892.jpg
    â””â”€â”€ ...
```

è¿™æ ·æ¯ä¸ªç”¨æˆ·çš„å¤´åƒéƒ½å­˜å‚¨åœ¨ `avatars/` æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–‡ä»¶ååŒ…å«ç”¨æˆ· ID å’Œæ—¶é—´æˆ³ï¼Œç¡®ä¿å”¯ä¸€æ€§ã€‚

---

## ğŸ¯ å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å·²åˆ›å»º `user-uploads` å­˜å‚¨æ¡¶
- [ ] å­˜å‚¨æ¡¶è®¾ç½®ä¸º Public
- [ ] å·²è¿è¡Œ RLS ç­–ç•¥ SQL è„šæœ¬
- [ ] å·²æµ‹è¯•å¤´åƒä¸Šä¼ åŠŸèƒ½
- [ ] ä¸Šä¼ çš„å¤´åƒèƒ½æ­£å¸¸æ˜¾ç¤º
- [ ] åˆ·æ–°é¡µé¢åå¤´åƒä¿æŒä¸å˜

å®Œæˆæ‰€æœ‰æ­¥éª¤åï¼Œå¤´åƒä¸Šä¼ åŠŸèƒ½å°±å®Œå…¨å¯ç”¨äº†ï¼ğŸ‰
