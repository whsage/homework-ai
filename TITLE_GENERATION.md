# 会话标题生成机制

## 问题描述
之前所有作业会话都显示为"New Homework Session"或"微积分题目 #102"，无法反映实际的题目内容。

## 解决方案

### 1. 两阶段标题生成策略

#### 阶段 1：临时标题（立即生成）
当用户上传文件或发送消息时，系统会立即生成一个临时标题：

**上传文件时** (`UploadZone.jsx`)：
- 使用文件名（去除扩展名）作为临时标题
- 如果文件名超过20个字符，截取前20个字符并添加"..."
- 示例：`IMG_20260112_143000.jpg` → `IMG_20260112_143000`

**发送消息时** (`aiService.js`)：
- 使用用户消息的前20个字符作为临时标题
- 如果消息超过20个字符，添加"..."
- 如果没有消息，使用"作业题目"作为默认值

#### 阶段 2：智能标题（AI 自动更新）
当 AI 分析题目后，会自动生成一个5-10字的智能摘要标题：

**AI 标题生成规则**：
- **数学题**：提取核心概念
  - 示例："出租车速度问题"、"分数加减法"、"三角形面积"
- **语文题**：提取主题
  - 示例："拼音辨析"、"古诗词鉴赏"、"阅读理解"
- **英语题**：提取重点
  - 示例："时态练习"、"单词拼写"、"完形填空"
- **其他科目**：简洁描述题目类型

### 2. 代码改进

#### `UploadZone.jsx`
```javascript
// 从文件名生成临时标题
const fileBaseName = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
const tempTitle = fileBaseName.length > 20 
    ? fileBaseName.slice(0, 20) + "..." 
    : fileBaseName || "作业题目";
```

#### `aiService.js`
```javascript
// 从用户消息生成临时标题
const tempTitle = userMessage 
    ? (userMessage.length > 20 ? userMessage.slice(0, 20) + "..." : userMessage)
    : "作业题目";
```

#### AI 系统提示优化
- 明确要求 AI 在第一条消息时**必须**生成 `title` 字段
- 提供详细的标题生成规则和示例
- 强调标题应该是5-10字的简短摘要

### 3. 自动更新机制

AI 返回的 JSON 格式：
```json
{
  "analysis": "内部分析",
  "hint": "简短提示",
  "guidance": "详细引导",
  "subject": "Math",
  "title": "出租车速度问题"  // 第一条消息时必填
}
```

系统会自动检测并更新：
```javascript
if (parsedResponse.title) {
    updateData.title = parsedResponse.title;
}
if (parsedResponse.subject) {
    updateData.subject = parsedResponse.subject;
}
```

### 4. DocumentViewer 显示优化

现在 `DocumentViewer` 会动态显示：
- 会话标题（从数据库获取）
- 会话编号（使用 session ID 的前4位）

示例显示：
- `出租车速度问题 #249a`
- `拼音辨析 #4489`
- `分析行程时间与限速 #3070`

## 用户体验流程

1. **用户上传图片** → 显示临时标题（基于文件名）
2. **AI 开始分析** → 临时标题保持显示
3. **AI 返回结果** → 标题自动更新为智能摘要
4. **用户看到** → 有意义的标题，清晰反映题目内容

## 优势

✅ **即时反馈**：上传后立即显示有意义的临时标题  
✅ **智能优化**：AI 分析后自动更新为更好的摘要  
✅ **清晰识别**：每个作业都有独特、描述性的标题  
✅ **无需等待**：不会出现长时间显示"New Homework Session"的情况  
✅ **兼容性好**：即使 AI 未返回标题，临时标题也足够有用

## 测试建议

1. 上传一张数学题图片，观察标题变化
2. 上传一张语文题图片，观察标题变化
3. 在聊天界面直接发送文字消息，观察标题生成
4. 检查"我的作业"页面，确认所有会话都有合适的标题
